# SNS-based Sat-API updater
## Sept. 8, 2017

### Goal
Use the SNS push notifications generated by AWS to update to update the Sat-API with new Sentinel 2 metadata. This would be better than the current working solution of scraping the bucket daily for new additions to the repository, because it would be more efficient and result in faster updates. New products appear to come in at a rate of about 2 per minute (average).

### Architecture

- Sentinel 2 (satellite)
- Ingested into ESA portal
- Ingested into AWS S3 bucket
- SNS notification
- AWS Lambda function
- Serve sat-api using elastic search

### What I accomplished so far

- Subscribed to SNS notifications. The SNS notifications are automatically generated when the sentinel 2 bucket is updated. The messages come from `arn:aws:sns:eu-west-1:214830741341:NewSentinel2Product` and look like this:

<pre>
{
  "Records": [
    {
      "EventVersion": "1.0",
      "EventSubscriptionArn": "arn:aws:sns:eu-west-1:214830741341:NewSentinel2Product:fbc81a1b-e53f-4cd2-a26b-d70efa534c92",
      "EventSource": "aws:sns",
      "Sns": {
        "SignatureVersion": "1",
        "Timestamp": "2017-09-08T17:10:43.133Z",
        "Signature": "M0r9TyTjWaLm86ZKwVlHot\/bkCcsJv13qkNOm5kG2Nhnqf7tdu9hCJ1GWMClIpBPf1xpgwDJ1swNEPgqayqfmTvnbeYo47oEI\/TcszSR7npRcNDZuAXJor7\/nqucEiUAg+4YrKMSCk77abafI3aSbX\/Z\/7LGEyQitWYiKbfoBjKzDk1wDpCJp7amv0cpiJqDk1r+gygWiG8M9WIDjjtmQNN0SEk9Lfr2MhWHL\/x9KeRC+wgTvgbyqCykC2XJlp3IN4pB17lGSNWiKHndx6cZvA3jMiTWqjrRnk3NySF\/F6V3K70xoSjNDbC6sXiVBuB\/3GvmQuoFxByMhKj1sjGJkg==",
        "SigningCertUrl": "https:\/\/sns.eu-west-1.amazonaws.com\/SimpleNotificationService-433026a4050d206028891664da859041.pem",
        "MessageId": "e91a6f3a-d9dd-5d08-a658-3d16088e9863",
        "Message": {
          "name": "S2B_MSIL1C_20170811T012659_N0205_R074_T55UES_20170811T013019",
          "id": "f32bf1a2-2d71-4a87-a64e-e1a4cd221941",
          "path": "products\/2017\/8\/11\/S2B_MSIL1C_20170811T012659_N0205_R074_T55UES_20170811T013019",
          "timestamp": "2017-08-11T01:26:59.027Z",
          "datatakeIdentifier": "GS2B_20170811T012659_002245_N02.05",
          "sciHubIngestion": "2017-09-02T09:22:46.926Z",
          "s3Ingestion": "2017-09-08T17:10:42.312Z",
          "tiles": [
            {
              "path": "tiles\/55\/U\/ES\/2017\/8\/11\/0",
              "timestamp": "2017-08-11T01:30:19.107Z",
              "utmZone": 55,
              "latitudeBand": "U",
              "gridSquare": "ES",
              "datastrip": {
                "id": "S2B_OPER_MSI_L1C_DS_SGS__20170811T064431_S20170811T013019_N02.05",
                "path": "products\/2017\/8\/11\/S2B_MSIL1C_20170811T012659_N0205_R074_T55UES_20170811T013019\/datastrip\/0"
              }
            }
          ],
          "datastrips": [
            {
              "id": "S2B_OPER_MSI_L1C_DS_SGS__20170811T064431_S20170811T013019_N02.05",
              "path": "products\/2017\/8\/11\/S2B_MSIL1C_20170811T012659_N0205_R074_T55UES_20170811T013019\/datastrip\/0"
            }
          ]
        },
        "MessageAttributes": {

        },
        "Type": "Notification",
        "UnsubscribeUrl": "https:\/\/sns.eu-west-1.amazonaws.com\/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:214830741341:NewSentinel2Product:fbc81a1b-e53f-4cd2-a26b-d70efa534c92",
        "TopicArn": "arn:aws:sns:eu-west-1:214830741341:NewSentinel2Product",
        "Subject": "S2B_MSIL1C_20170811T012659_N0205_R074_T55UES_20170811T013019"
      }
    }
  ]
}
</pre>

- Run a lambda function each time a new message is received.

  - In python 2.7 (but see below)
  - Parse the json body of the message
  - Find and download the metadata of the product and the specific scene (tile) that has been updated, using the name of the product passed in the SNS notification.
    - Most of this was easy to do using the python libraries in the [Sentinel_S3](https://github.com/developmentseed/sentinel-s3) repository. This repo has the code that is currently used for scraping the whole bucket. I took the functions for parsing single products (`single_metadata`) and called it for each new scene.
  - Update the elasticsearch index with the new metadata so it can be served via sat-api.
    - Mot of this logic was inspired by the (now deprecated) [metadata](https://github.com/sat-utils/sentinel2-metadata) library.
    - I created a custom elastic search domain for testing, since there is not currently a development version of the sat-api elastic search domain.
    - I focused on making sure that the ES domain was being populated with the metadata (IE, there might be a gap between what the Ssat-API is expecting, and what the updater is giving it).
    - I started running the lambda->ES after lunch of Friday and as of 3:30, it has been updated with 447 new scenes.
  - Started writing unit tests

- Started porting the python lambda described above into the node/javascript.
  - Most of the code in the `sat-api` library is in node, so it would be cleaner if the updater lambda function was also in node, rather than in python.
  - I would estimate I am ~70% done with the node implementation
  - Parses the metadata for products and tiles.
  - Finished by working on populating the ES domain, but still buggy.

- Placed the code in the `sat-api/lambdas` repo/folder. Makes the most sense here, since the API will be able to update itself.

### Challenges

- Running lambdas with spatial libs.
  - Incorrect architectures.
    - Since I was working on a mac, the shared C libraries were built with incorrect headers. Possible solution was to build with docker then upload, but that was also problematic.
    - Wound up using geolambas, which took care of the architecture problem.
  - Problems with specific folder structure required by AWS.
    - Geolamba packages python libraries into `lib/python27/site-packages`, but AWS Lambda expects that python packages are in the root of the project directory, per the documentation [here](http://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html). Ended up with manual work around to move the code into the root of the zip folder, but could easily be modified with the geolamba packaging script or a custom bash script.  

- Making sense of the different existing libraries (`n>4`). But, most of the existing code was able to be re-used.
  - [Scraping utilities](https://github.com/developmentseed/sentinel-s3)
  - [Updating utilities](https://github.com/sat-utils/sentinel2-metadata) [marked as deprecated]
  - [Sat API core libraries](https://github.com/sat-utils/sat-api-lib)
  - [Sat API AWS/ES/APIGateway implementation](https://github.com/sat-utils/sat-api)
  - [Sat API express implementation](https://github.com/sat-utils/sat-api-express)

### Next Steps

- Check to see that the sat-api consumes what the updater is producing. This will (I think) require the next step of building a new version of the sat-api running off a new ES domain.

- Create development version for sat-api. Probably want to keep this separate from existing, especially while update kinks are worked out. Requires :
  - new elastic search domain
  - new AWS bucket
  - AWS lambda function [DONE][arn:aws:lambda:us-east-1:552819999234:function:sat-api-updater].

- Deploy the lambda using the kes/cf tools. I had some trouble setting them up, so didn't get around to working with it.

- Finish the node/javascript implementation.  
  - Make sure the structure of the produced json matches with that produced using the existing libraries/python script. There's a lot of CaSeManIpUlaTiOn, name standardization, property removal, etc. One would want to study the schema of the existing output to make sure it matches.
  - Make sure the ES link works. I got close, but ran out of time.
  - Major challenge: figuring out the proper spatial libraries to do coordinate conversion on the rasters (they're not in lat/lng but they should be)


## Steps for the python lambda
  - `docker-compose build`
  - `docker-compose run package`
  - Unzip `lambda-deploy.zip`.
  - Move python libs from `lib/python27/site-packages` to the root of the zip file.
  - Zip the contents of `lambda-deploy` from the root using `zip -r lambda-deploy-root.zip .`
  - Upload the package to aws `aws lambda update-function-code --function-name sat-api-updater --zip fileb://lambda-deploy-root.zip`
  - [Optional] Test the lambda using `aws lamba invoke --function-name sat-api-updater --payload file://test/data/event_message.json results.txt`.


## Results

Look like this:

<pre>
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "failed": 0
  },
  "hits": {
    "total": 639,
    "max_score": 1,
    "hits": [
      {
        "_index": "sat-api",
        "_type": "sentinel2",
        "_id": "S2A_tile_20170811_56WPU_0",
        "_score": 1,
        "_source": {
          "scene_id": "S2A_tile_20170811_56WPU_0",
          "original_scene_id": "S2B_OPER_MSI_L1C_TL_SGS__20170811T045712_A002245_T56WPU_N02.05",
          "satellite_name": "Sentinel-2B",
          "cloud_coverage": 95.2,
          "date": "2017-08-11",
          "thumbnail": "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/preview.jp2",
          "tile_geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  155.26620536778,
                  66.702563123431
                ],
                [
                  157.74674909257,
                  66.647231348418
                ],
                [
                  157.56600757654,
                  65.665420033651
                ],
                [
                  155.17962683568,
                  65.718249413077
                ],
                [
                  155.26620536778,
                  66.702563123431
                ]
              ]
            ]
          },
          "data_coverage_percentage": 100,
          "cloudy_pixel_percentage": 95.2,
          "latitude_band": "W",
          "product_name": "S2B_MSIL1C_20170811T012659_N0205_R074_T56WPU_20170811T012653",
          "tile_origin": {
            "type": "Point",
            "coordinates": [
              155.26620536778,
              66.702563123431
            ]
          },
          "utm_zone": 56,
          "product_path": "products\/2017\/8\/11\/S2B_MSIL1C_20170811T012659_N0205_R074_T56WPU_20170811T012653",
          "timestamp": "2017-08-11T01:26:53.464Z",
          "grid_square": "PU",
          "spacecraft_name": "Sentinel-2B",
          "product_stop_time": "2017-08-11T01:26:59.027Z",
          "processing_level": "Level-1C",
          "product_type": "S2MSI1C",
          "processing_baseline": "02.05",
          "sensing_orbit_number": 74,
          "sensing_orbit_direction": "DESCENDING",
          "product_format": "SAFE_COMPACT",
          "product_cloud_coverage_assessment": 95.2024,
          "product_meta_link": "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/products\/2017\/8\/11\/S2B_MSIL1C_20170811T012659_N0205_R074_T56WPU_20170811T012653\/metadata.xml",
          "download_links": {
            "aws_s3": [
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B01.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B02.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B03.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B04.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B05.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B06.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B07.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B08.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B8A.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B09.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B10.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B11.jp2",
              "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/B12.jp2"
            ]
          },
          "original_tile_meta": "http:\/\/sentinel-s2-l1c.s3.amazonaws.com\/tiles\/56\/W\/PU\/2017\/8\/11\/0\/tileInfo.json",
          "aws_path": "tiles\/56\/W\/PU\/2017\/8\/11\/0",
          "data_geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  155.26622718514,
                  66.702553833859
                ],
                [
                  157.74672484523,
                  66.647223089882
                ],
                [
                  157.56598747468,
                  65.665429627947
                ],
                [
                  155.17964936822,
                  65.718258067477
                ],
                [
                  155.26622718514,
                  66.702553833859
                ]
              ]
            ]
          }
        }
      }
    ]
  }
}
</pre>
